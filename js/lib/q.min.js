(function(n,c){typeof define==="function"?define(function(c,e,o){n(c,e,o)}):typeof exports==="object"?n(require,exports,module):Q=n(c,{},{})})(function(n,c,H,e){function o(a){return a}function p(){var a=[],b,d=r(f.prototype);d.promiseSend=function(){var d=j.call(arguments);a?a.push(d):k(function(){b.promiseSend.apply(b,d)})};d.valueOf=function(){if(a)return d;return m(b)};var c=function(d){if(a)return b=h(d),t.call(a,function(a,d){k(function(){b.promiseSend.apply(b,d)})},e),a=e,b};return{promise:u(d),
resolve:c,reject:function(a){return c(i(a))}}}function f(a,b,d){b===e&&(b=function(a){return i("Promise does not support operation: "+a)});var c=r(f.prototype);c.promiseSend=function(d,c){var y=j.call(arguments,2),e;try{e=a[d]?a[d].apply(a,y):b.apply(a,[d].concat(y)),c=c||o}catch(f){e=i(f)}return c(e)};if(d)c.valueOf=d;return u(c)}function s(a){return a&&typeof a.promiseSend==="function"}function z(a){return!s(m(a))&&!v(a)}function v(a){a=m(a);if(a===e||a===A)return!1;return!!a.promiseRejected}function i(a){return f({when:function(b){return b?
b(a):i(a)}},function(){return i(a)},function(){var b=r(i.prototype);b.promiseRejected=!0;b.reason=a;return b})}function h(a){if(s(a))return a;if(a&&typeof a.then==="function")return f({},function(b){return b!=="when"?g(a,function(a){return h(a).promiseSend.apply(e,arguments)}):(b=p(),a.then(b.resolve,b.reject),b.promise)});return f({when:function(){return a},get:function(b){return a[b]},put:function(b,d){return a[b]=d},del:function(b){return delete a[b]},post:function(b,d){return a[b].apply(a,d)},
apply:function(b,d){return a.apply(b,d)},viewInfo:function(){for(var b=a,d={};b;)Object.getOwnPropertyNames(b).forEach(function(a){d[a]||(d[a]=typeof b[a])}),b=Object.getPrototypeOf(b);return{type:typeof a,properties:d}},keys:function(){return I(a)}},e,function(){return a})}function B(a,b){a=h(a);return b?f({viewInfo:function(){return b}},function(){var b=j.call(arguments);return q.apply(e,[a].concat(b))},function(){return a.valueOf()}):q(a,"viewInfo")}function g(a,b,d){function c(a){try{return b?
b(a):a}catch(d){return i(d)}}function e(a){try{return d?d(a):i(a)}catch(b){return i(b)}}var f=p(),g=!1;k(function(){h(a).promiseSend("when",function(a){g||(g=!0,f.resolve(h(a).promiseSend("when",c,e)))},function(a){g||(g=!0,f.resolve(e(a)))})});return f.promise}function l(a){return function(b){var d=j.call(arguments,1);return q.apply(e,[b,a].concat(d))}}function q(a,b){var d=p(),c=j.call(arguments,2),a=h(a);k(function(){a.promiseSend.apply(a,[b,d.resolve].concat(c))});return d.promise}function w(a){return g(a,
function(a){var d=a.length,c=[];if(d===0)return h(c);var f=p();t.call(a,function(a,b,e){g(b,function(a){c[e]=a;--d===0&&f.resolve(c)},f.reject)},e);return f.promise})}var k;try{k=n("event-queue").enqueue}catch(J){if(typeof MessageChannel!=="undefined"){var C=new MessageChannel,x={},D=x;C.port1.onmessage=function(){var a=x.next,b=a.task;x=a;b()};k=function(a){D=D.next={task:a};C.port2.postMessage()}}else k=function(a){setTimeout(a,0)}}var u=Object.freeze=Object.freeze||o,r=Object.create=Object.create||
function(a){var b=function(){};b.prototype=a;return new b},I=Object.keys=Object.keys||function(a){var b=[],d;for(d in a)b.push(d);return b},t=Array.prototype.reduce=Array.prototype.reduce||function(a,b){for(var d=0,c=this.length;d<c;d++)b=a(b,this[d],d);return b},j=Array.prototype.slice,A=null;c.enqueue=k;c.defer=p;c.makePromise=f;f.prototype.then=function(a,b){return g(this,a,b)};t.call(["when","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","spy",
"view","viewInfo","end"],function(a,b){f.prototype[b]=function(){return c[b].apply(c,[this].concat(j.call(arguments)))}},e);f.prototype.toSource=function(){return this.toString()};f.prototype.toString=function(){return"[object Promise]"};u(f.prototype);c.isPromise=s;c.isResolved=function(a){return!s(m(a.valueOf()))};c.isFulfilled=z;c.isRejected=v;c.reject=i;i.prototype=r(f.prototype,{constructor:{value:i}});c.ref=h;c.master=c.def=function(a){return f({isDef:function(){}},function(){var b=j.call(arguments);
return q.apply(e,[a].concat(b))},function(){return a.valueOf()})};c.viewInfo=B;c.view=function(a){return B(a).when(function(b){var d;d=b.type==="function"?function(){return E(a,e,arguments)}:{};var c=b.properties||{};Object.keys(c).forEach(function(b){c[b]==="function"&&(d[b]=function(){return F(a,b,arguments)})});return h(d)})};c.when=g;c.asap=function(a,b,d){b=b||o;if(z(a))return m(b(m(a)));else if(v(a))if(a=a.valueOf().reason,d)return d(a);else throw a;else return g(a,b,d)};var m=function(a){return a===
e||a===A?a:a.valueOf()};c.async=function(a){return function(){var b=function(a,b){var f;try{f=d[a](b)}catch(h){return Object.prototype.toString.call(h)==="[object StopIteration]"?h.value:i(h)}return g(f,c,e)},d=a.apply(this,arguments),c=b.bind(b,"send"),e=b.bind(b,"throw");return c()}};c.Method=l;c.send=q;c.get=l("get");c.put=l("put");c.del=l("del");var F=c.post=l("post");c.invoke=function(a,b){var d=j.call(arguments,2);return F(a,b,d)};var E=c.apply=l("apply");c.call=function(a,b){var d=j.call(arguments,
2);return E(a,b,d)};c.keys=l("keys");c.all=w;c.wait=function(){return w(arguments).get(0)};c.join=function(){var a=j.call(arguments),b=a.pop();return w(a).then(function(a){return b.apply(e,a)})};c.fail=function(a,b){return g(a,e,b)};c.spy=c.fin=function(a,b){return g(a,function(a){return g(b(),function(){return a})},function(a){return g(b(),function(){return i(a)})})};c.end=function(a){g(a,e,function(a){k(function(){throw a;})})};for(var G in c)h[G]=c[G];return H.exports=h});